name: Static - Security Pipeline

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Git repository URL (e.g., https://github.com/flaskbb/flaskbb.git)"
        required: true
        default: "https://github.com/flaskbb/flaskbb.git"
      target_ref:
        description: "Branch/Tag/Commit of the target application (e.g., main)"
        required: false
        default: "master"
  workflow_call:
    inputs:
      target_repo:
        description: "Git repository URL (e.g., https://github.com/flaskbb/flaskbb.git)"
        required: true
        type: string
      target_ref:
        description: "Branch/Tag/Commit of the target application (e.g., main)"
        required: false
        type: string
  # push:
  #   branches: []

jobs:
  clone:
    name: Clone target repository
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: ${{ inputs.target_repo || github.event.inputs.target_repo || 'https://github.com/flaskbb/flaskbb.git' }}
      TARGET_REF:  ${{ inputs.target_ref  || github.event.inputs.target_ref  || 'master' }}
      APP_DIR:     ${{ github.workspace }}/target-app
    steps:
      - name: Checkout (this delivery repo)
        uses: actions/checkout@v4

      - name: Clone target application (public repo only)
        run: |
          echo "Cloning ${TARGET_REPO} (ref: ${TARGET_REF}) into ${APP_DIR} ..."
          git clone --depth 1 --branch "${TARGET_REF}" "${TARGET_REPO}" "${APP_DIR}"

          echo "Clone completed. Top-level files:"
          ls -la "${APP_DIR}"

      - name: Upload target app as artifact
        uses: actions/upload-artifact@v4
        with:
          name: target-app
          path: target-app/
          retention-days: 7 

  sast:
    name: Static Analysis — SAST (Semgrep)
    runs-on: ubuntu-latest
    needs: clone
    container:
      image: semgrep/semgrep:1.131.0
    steps:
      - name: Checkout (this delivery repo)
        uses: actions/checkout@v4

      - name: Download target app artifact
        uses: actions/download-artifact@v4
        with:
          name: target-app
          path: ./target-app

      - name: Run Semgrep (Semgrep CE recommended)
        run: |
          semgrep scan \
            --config p/security-audit \
            --timeout 180 \
            --metrics=off \
            --exclude node_modules --exclude venv --exclude .venv --exclude .git \
            --json --output semgrep-report.json \
            ./target-app
        continue-on-error: true

      - name: Upload SAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SAST-semgrep
          path: semgrep-report.json


  sca:
    name: Static Analysis — SCA (OSV-Scanner)
    runs-on: ubuntu-latest
    needs: clone
    steps:
      - name: Checkout (this delivery repo)
        uses: actions/checkout@v4

      - name: Download target app artifact
        uses: actions/download-artifact@v4
        with:
          name: target-app
          path: ./target-app

      - name: Run OSV-Scanner (official action)
        uses: google/osv-scanner-action/osv-scanner-action@v2.2.2
        with:
          scan-args: |-
            --recursive
            --format json
            --output osv-scanner-result.json
            ./target-app
        continue-on-error: true

      - name: Upload SCA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SCA-osv-scanner
          path: osv-scanner-result.json
